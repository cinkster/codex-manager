{{ define "index" }}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Codex Sessions</title>
  {{ template "style" . }}
</head>
<body class="{{ .ThemeClass }}">
  <header>
    <p class="subtitle">Codex sessions browser</p>
    <h1 class="page-title">{{ if eq .View "dir" }}Available Directories{{ else }}Available Dates{{ end }}</h1>
    <div class="tabs">
      <a class="tab {{ if eq .View "date" }}active{{ end }}" href="/?view=date">By date</a>
      <a class="tab {{ if eq .View "dir" }}active{{ end }}" href="/?view=dir&heat={{ .HeatMode }}">By directory</a>
    </div>
    {{ if eq .View "dir" }}
    <div class="tabs tabs-secondary">
      <span class="tab-label">Heat</span>
      <a class="tab {{ if eq .HeatMode "7d" }}active{{ end }}" href="/?view=dir&heat=7d">7d</a>
      <a class="tab {{ if eq .HeatMode "today" }}active{{ end }}" href="/?view=dir&heat=today">Today</a>
      <a class="tab {{ if eq .HeatMode "1h" }}active{{ end }}" href="/?view=dir&heat=1h">1h</a>
    </div>
    {{ end }}
  </header>
  <main>
    <div class="card search-card">
      <label class="search-label" for="search-input">Search sessions</label>
      <input id="search-input" class="search-input" type="search" placeholder="Search across all sessions" autocomplete="off" spellcheck="false">
      <p id="search-status" class="meta search-status"></p>
      <ul id="search-results" class="list search-results"></ul>
    </div>
    <div class="card">
      {{ if eq .View "dir" }}
        {{ if .Dirs }}
        <div class="dir-filter-controls">
          <label class="dir-filter-toggle" for="heat-only-toggle">
            <input id="heat-only-toggle" class="dir-filter-checkbox" type="checkbox" checked>
            <span>Only show heat-colored directories</span>
          </label>
        </div>
        <p id="heat-only-empty" class="meta dir-filter-empty" hidden>No heat-colored directories for this range.</p>
        <ul id="dir-list" class="list link-list">
          {{ range .Dirs }}
          <li class="dir-item" data-has-heat="{{ if .HeatColor }}true{{ else }}false{{ end }}"{{ if .HeatColor }} style="background-color: {{ .HeatColor }};"{{ end }}>
            <a class="link-item-link" href="/dir?cwd={{ .Value | urlquery }}">
              {{ .Label }}
              <span class="meta">{{ .Count }} session{{ if ne .Count 1 }}s{{ end }}</span>
            </a>
          </li>
          {{ end }}
        </ul>
        {{ else }}
        <p class="meta">No sessions found in {{ .SessionsDir }}</p>
        {{ end }}
      {{ else }}
        {{ if .Dates }}
        <ul class="list link-list">
          {{ range .Dates }}
          <li>
            <a class="link-item-link" href="/{{ .Path }}/">
              {{ .Label }}
              <span class="meta">{{ .Count }} session{{ if ne .Count 1 }}s{{ end }}</span>
            </a>
          </li>
          {{ end }}
        </ul>
        {{ else }}
        <p class="meta">No sessions found in {{ .SessionsDir }}</p>
        {{ end }}
      {{ end }}
    </div>
    <p class="meta">Last scan: {{ .LastScan }}</p>
  </main>
  <script>
    (function () {
      var input = document.getElementById("search-input");
      var results = document.getElementById("search-results");
      var status = document.getElementById("search-status");
      if (!input || !results || !status) return;

      var minChars = 2;
      var debounceMs = 250;
      var timer = null;
      var controller = null;
      var lastQuery = "";

      function setStatus(message) {
        status.textContent = message || "";
      }

      function clearResults(message) {
        results.innerHTML = "";
        setStatus(message);
      }

      function highlightText(container, text, query) {
        if (!query) {
          container.textContent = text;
          return;
        }
        var lowerText = text.toLowerCase();
        var lowerQuery = query.toLowerCase();
        var start = 0;
        var index = lowerText.indexOf(lowerQuery, start);
        if (index === -1) {
          container.textContent = text;
          return;
        }
        while (index !== -1) {
          if (index > start) {
            container.appendChild(document.createTextNode(text.slice(start, index)));
          }
          var mark = document.createElement("mark");
          mark.textContent = text.slice(index, index + query.length);
          container.appendChild(mark);
          start = index + query.length;
          index = lowerText.indexOf(lowerQuery, start);
        }
        if (start < text.length) {
          container.appendChild(document.createTextNode(text.slice(start)));
        }
      }

      function renderResults(data, query) {
        results.innerHTML = "";
        if (!data || !data.results || data.results.length === 0) {
          if (query.length >= minChars) {
            setStatus("No results.");
          } else {
            setStatus("Type at least " + minChars + " characters to search.");
          }
          return;
        }
        setStatus(data.results.length + " result" + (data.results.length === 1 ? "" : "s") + ".");
        data.results.forEach(function (item) {
          var li = document.createElement("li");
          li.className = "search-result";

          var link = document.createElement("a");
          link.className = "search-result-link";
          link.href = "/" + item.path + "/" + item.file + "#line-" + item.line;
          link.textContent = item.file;

          var meta = document.createElement("span");
          meta.className = "meta search-result-meta";
          var parts = [];
          if (item.timestamp) {
            parts.push(item.timestamp);
          } else if (item.date) {
            parts.push(item.date);
          }
          if (item.cwd) {
            parts.push(item.cwd);
          }
          parts.push("Line " + item.line);
          if (item.role) {
            parts.push(item.role);
          }
          meta.textContent = parts.join(" | ");

          li.appendChild(link);
          li.appendChild(meta);

          if (item.preview) {
            var snippet = document.createElement("div");
            snippet.className = "search-result-snippet";
            highlightText(snippet, item.preview, query);
            li.appendChild(snippet);
          }

          results.appendChild(li);
        });
      }

      function fetchResults(query) {
        if (controller) {
          controller.abort();
        }
        controller = new AbortController();
        setStatus("Searching...");
        fetch("/search?query=" + encodeURIComponent(query) + "&limit=50", {
          method: "GET",
          credentials: "same-origin",
          signal: controller.signal
        })
          .then(function (response) {
            if (!response.ok) throw new Error("search failed");
            return response.json();
          })
          .then(function (data) {
            renderResults(data, query);
          })
          .catch(function (error) {
            if (error.name === "AbortError") return;
            setStatus("Search failed.");
          });
      }

      input.addEventListener("input", function () {
        var query = input.value.trim();
        if (query === lastQuery) return;
        lastQuery = query;
        if (timer) {
          clearTimeout(timer);
        }
        if (query.length < minChars) {
          clearResults("Type at least " + minChars + " characters to search.");
          return;
        }
        timer = setTimeout(function () {
          fetchResults(query);
        }, debounceMs);
      });

      clearResults("Type at least " + minChars + " characters to search.");
    })();

    (function () {
      var toggle = document.getElementById("heat-only-toggle");
      var list = document.getElementById("dir-list");
      var emptyMessage = document.getElementById("heat-only-empty");
      if (!toggle || !list) return;

      function applyFilter() {
        var items = list.querySelectorAll(".dir-item");
        var showHeatOnly = toggle.checked;
        var visibleCount = 0;
        for (var i = 0; i < items.length; i++) {
          var item = items[i];
          var hasHeat = item.getAttribute("data-has-heat") === "true";
          var hidden = showHeatOnly && !hasHeat;
          item.style.display = hidden ? "none" : "";
          if (!hidden) visibleCount++;
        }
        if (emptyMessage) {
          emptyMessage.hidden = !(showHeatOnly && visibleCount === 0);
        }
      }

      toggle.addEventListener("change", applyFilter);
      applyFilter();
    })();
  </script>
</body>
</html>
{{ end }}
