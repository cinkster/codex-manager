{{ define "session" }}
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ .File.Name }} - Codex Session</title>
  {{ template "style" . }}
</head>
<body class="{{ .ThemeClass }} has-sticky-header">
  <header class="sticky-header">
    <p class="subtitle"><a href="/">All dates</a> / <a href="/{{ .Date.Path }}/">{{ .Date.Label }}</a></p>
    <h1 class="page-title">{{ .File.Name }}</h1>
    <p class="meta">{{ .File.Size }} | {{ .File.ModTime }}{{ if .File.Cwd }} | CWD: {{ .File.Cwd }}{{ if .ResumeCommand }} (<a href="#" data-copy-id="resume-cmd">Copy resume command</a>){{ end }}{{ end }}{{ if and (not .File.Cwd) .ResumeCommand }}
      | <a href="#" data-copy-id="resume-cmd">Copy resume command</a>{{ end }} | <a href="#" data-copy-id="md-all">Copy thread as Markdown</a>
      {{ if and .IsJSONL (gt .LastUserLine 0) }}| <a href="#line-{{ .LastUserLine }}">Jump to last user message</a> | <a id="jump-user-prev" href="#" aria-label="Previous user message" title="Previous user message">[&uarr;]</a> <a id="jump-user-next" href="#" aria-label="Next user message" title="Next user message">[&darr;]</a>{{ end }}
      | <form class="share-form" method="post" action="/share/{{ .Date.Path }}/{{ .File.Name }}">
        <button class="copy-btn" type="submit">Share</button>
      </form>
    </p>
    <div id="share-banner" class="share-banner" role="status" aria-live="polite"></div>
    {{ if .ResumeCommand }}
    <textarea id="resume-cmd" class="copy-source">{{ .ResumeCommand }}</textarea>
    {{ end }}
    <textarea id="md-all" class="copy-source">{{ .AllMarkdown }}</textarea>
  </header>
  <main>
    {{ if .Meta }}
    <div class="card">
      <p class="meta"><span class="tag">Session {{ .Meta.ID }}</span></p>
      <p class="meta">CWD: {{ .Meta.Cwd }}</p>
      <p class="meta">Originator: {{ .Meta.Originator }} | CLI: {{ .Meta.CliVersion }}</p>
      <details>
        <summary class="meta">Instructions</summary>
        <pre class="session-content">{{ .Meta.Instructions }}</pre>
      </details>
    </div>
    {{ end }}

    {{ if .Items }}
      {{ range .Items }}
      <section id="line-{{ .Line }}" class="session-item {{ .Class }}">
        <div class="session-header">
          <span class="session-title">{{ .Title }}</span>
          <span class="session-type">{{ .Type }}{{ if .Subtype }}:{{ .Subtype }}{{ end }}</span>
          <span class="meta">{{ .Timestamp }}</span>
          {{ if .Role }}<span class="tag">{{ .Role }}</span>{{ end }}
          {{ if .AutoCtx }}<span class="tag tag-auto">Auto context</span>{{ end }}
          <span class="meta">Line {{ .Line }}</span>
          <button class="copy-btn" type="button" data-copy-id="md-{{ .Line }}" aria-label="Copy Markdown" title="Copy Markdown">ðŸ“‹</button>
          <button class="copy-btn" type="button" data-copy-link="line-{{ .Line }}" aria-label="Copy Link" title="Copy Link">ðŸ”—</button>
        </div>
        {{ if eq .Subtype "reasoning" }}
        <details>
          <summary class="meta">Reveal reasoning</summary>
          <div class="session-content markdown">{{ .HTML }}</div>
        </details>
        {{ else if .AutoCtx }}
        <details>
          <summary class="meta">Reveal Context</summary>
          <div class="session-content markdown">{{ .HTML }}</div>
        </details>
        {{ else }}
        <div class="session-content markdown">{{ .HTML }}</div>
        {{ end }}
        <textarea id="md-{{ .Line }}" class="copy-source">{{ .Markdown }}</textarea>
      </section>
      {{ end }}
    {{ else }}
      <p class="meta">No items found in this session.</p>
    {{ end }}
  </main>
  <script>
    (function () {
      var stickyHeader = document.querySelector("header.sticky-header");
      var main = document.querySelector("main");
      function updateStickyOffset() {
        if (!stickyHeader || !main) return;
        var height = stickyHeader.offsetHeight;
        document.documentElement.style.setProperty("--sticky-offset", height + "px");
      }
      updateStickyOffset();
      window.addEventListener("resize", updateStickyOffset);

      function copyText(text, target) {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(text).catch(function () {});
          return;
        }
        var area = document.createElement("textarea");
        area.value = text;
        area.setAttribute("readonly", "readonly");
        area.style.position = "absolute";
        area.style.left = "-9999px";
        document.body.appendChild(area);
        area.select();
        document.execCommand("copy");
        document.body.removeChild(area);
      }

      document.addEventListener("click", function (event) {
        var target = event.target;
        if (!(target instanceof HTMLElement)) return;
        var trigger = target.closest("[data-copy-id],[data-copy-link]");
        if (!trigger) return;
        event.preventDefault();
        var id = trigger.getAttribute("data-copy-id");
        if (id) {
          var source = document.getElementById(id);
          if (!source) return;
          var text = source.value || source.textContent || "";
          copyText(text, trigger);
          return;
        }
        var anchorId = trigger.getAttribute("data-copy-link");
        if (!anchorId) return;
        var origin = window.location.origin;
        if (!origin) {
          origin = window.location.protocol + "//" + window.location.host;
        }
        var base = origin + window.location.pathname + window.location.search;
        copyText(base + "#" + anchorId, trigger);
      });

      var shareForm = document.querySelector(".share-form");
      var shareBanner = document.getElementById("share-banner");
      if (shareForm && shareBanner) {
        shareForm.addEventListener("submit", function (event) {
          event.preventDefault();
          fetch(shareForm.action, { method: "POST", credentials: "same-origin" })
            .then(function (response) { return response.json(); })
            .then(function (data) {
              if (!data || !data.url) return;
              copyText(data.url, shareForm);
              shareBanner.textContent = "Copied share URL: " + data.url;
              shareBanner.classList.add("visible");
            })
            .catch(function () {});
        });
      }

      var jumpPrev = document.getElementById("jump-user-prev");
      var jumpNext = document.getElementById("jump-user-next");
      if (jumpPrev || jumpNext) {
        var userSections = Array.prototype.slice.call(
          document.querySelectorAll("section.session-item.role-user:not(.auto-context)")
        );
        var getStickyOffset = function () {
          return stickyHeader ? stickyHeader.offsetHeight : 0;
        };
        var getSectionTop = function (section) {
          var rect = section.getBoundingClientRect();
          var scrollY = window.scrollY || window.pageYOffset || 0;
          return rect.top + scrollY;
        };
        var scrollToSection = function (section) {
          if (!section) return;
          var offset = getStickyOffset() + 8;
          var top = getSectionTop(section) - offset;
          if (top < 0) top = 0;
          if (typeof window.scrollTo === "function") {
            window.scrollTo({ top: top, behavior: "smooth" });
          } else {
            window.scrollTop = top;
          }
        };
        var findCurrentIndex = function () {
          var offset = getStickyOffset() + 8;
          var scrollY = window.scrollY || window.pageYOffset || 0;
          var position = scrollY + offset + 1;
          var current = -1;
          for (var i = 0; i < userSections.length; i++) {
            if (getSectionTop(userSections[i]) <= position) {
              current = i;
            } else {
              break;
            }
          }
          return current;
        };
        var goPrev = function (event) {
          if (event) event.preventDefault();
          if (!userSections.length) return;
          var index = findCurrentIndex();
          var target = index <= 0 ? 0 : index - 1;
          scrollToSection(userSections[target]);
        };
        var goNext = function (event) {
          if (event) event.preventDefault();
          if (!userSections.length) return;
          var index = findCurrentIndex();
          var target = index < 0 ? 0 : Math.min(index + 1, userSections.length - 1);
          scrollToSection(userSections[target]);
        };
        if (jumpPrev) jumpPrev.addEventListener("click", goPrev);
        if (jumpNext) jumpNext.addEventListener("click", goNext);
      }

    })();
  </script>
</body>
</html>
{{ end }}
